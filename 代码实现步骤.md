# INS/GNSS 融合项目代码实现步骤规划

> 目标：使用 Python 搭建一个完整的车载 MEMS IMU + 双天线 GNSS 姿态测量离线处理系统，  
> 包含：数据读取 → 纯 INS 积分 → 松耦合 ESKF → 紧耦合 ESKF → 遮挡实验 → 精度评估。  
> 神经网络仅作为可选的简单扩展，不是主线。

---

## 总体流程概览

整体数据流可以概括为：

1. **读取配置**（传感器参数、数据路径、实验设置）
2. **读入 IMU/GNSS/参考数据，并时间对齐**
3. **使用 IMU 进行纯 INS 惯导解算（名义状态）**
4. **构建误差状态模型（ESKF 的状态、误差方程、F/G/Q）**
5. **实现松耦合 ESKF（GNSS 导航解 + INS）**
6. **实现紧耦合 ESKF（GNSS 原始观测 + INS）**
7. **加入约束 & 遮挡控制（基线长度、静止约束、GNSS 遮挡模拟）**
8. **统一的精度评估与可视化**
9. **（可选扩展）简单神经网络辅助遮挡仿真**

---

## 第 0 步：搭建工程目录和模块骨架

**目标：**  
先搭好 Python 工程的目录结构，每个模块只写职责说明和占位结构，不实现细节。

**要点：**

- 设计若干子模块（目录），例如：
  - `config/`：配置文件（yaml/json 等）
  - `io/`：数据读取与时间对齐
  - `ins/`：纯惯导解算
  - `models/`：状态定义、误差方程、IMU/GNSS 模型
  - `fusion/`：ESKF 融合（松耦合 & 紧耦合）、约束
  - `eval/`：精度评估与绘图
  - `runners/`：实验主流程脚本
- 在每个文件中写清楚“这个模块负责什么”。

---

## 第 1 步：配置与试验参数管理

**目标：**  
所有可调参数集中管理，避免散落在代码中。

**配置内容建议：**

- **数据路径：**
  - IMU 原始数据文件
  - GNSS 原始数据文件
  - GNSS 导航解文件（松耦合用）
  - 参考轨迹/姿态数据（如果有）
- **IMU 参数：**
  - 采样频率
  - 角速度、加速度噪声水平
  - 零偏随机游走等
- **GNSS 参数：**
  - 输出频率
  - 伪距、伪距率/多普勒噪声水平
- **ESKF 参数：**
  - 状态维数（如 15 维误差状态）
  - 初始协方差
  - 过程噪声 Q（由 IMU 噪声推导）
  - 量测噪声 R（由 GNSS 精度设定）
- **实验设置：**
  - 启用松耦合 / 紧耦合的开关
  - GNSS 遮挡时间段列表（例如若干个 [t_start, t_end]）
  - （可选）是否启用 NN 辅助遮挡

---

## 第 2 步：数据读取与时间对齐（IO 层）

**目标：**  
把 IMU 和 GNSS 数据统一成“按时间排序的样本序列”。

**主要任务：**

1. **读取 IMU 数据：**
   - 时间戳
   - 三轴角速度
   - 三轴加速度

2. **读取 GNSS 数据：**
   - 用于松耦合：
     - GNSS 导航解：位置、速度、（可选）姿态
   - 用于紧耦合：
     - 原始观测：伪距、伪距率/多普勒、卫星号、卫星位置等

3. **时间对齐与插值：**
   - 以 IMU 采样时间为主时间轴
   - 对每个 IMU 时间点，关联最近或插值后的 GNSS 数据
   - 标记某些时间点“GNSS 不可用”（天然缺失 + 人为遮挡）

4. **坐标系与单位统一：**
   - GNSS 位置/速度统一到惯导导航坐标系（如 ENU/NED）
   - 检查 IMU 单位、方向符号是否一致

**输出：**

- 统一格式的时间序列，每个元素包含：
  - 时间戳
  - IMU 测量
  - GNSS 导航解（若有）
  - GNSS 原始观测（若有）
  - 参考真值（若有）
  - 遮挡标志（是否处于模拟遮挡期）

---

## 第 3 步：纯 INS 惯导解算（名义状态）

**目标：**  
仅依靠 IMU 数据，积分得到名义姿态、速度、位置，用作 ESKF 的基础。

**核心内容：**

- 选择姿态表示：
  - 推荐使用四元数
- 名义状态包含：
  - 姿态（四元数）
  - 速度（3 维，导航坐标系）
  - 位置（3 维，导航坐标系）
- 每个时间步进行：
  - 用角速度更新姿态
  - 将机体加速度旋转到导航坐标系并减去重力
  - 积分得到速度
  - 积分得到位置

**输出：**

- 每个时间点的名义状态序列（姿态、速度、位置），供 ESKF 使用。

---

## 第 4 步：误差状态 ESKF 模型建立（状态与误差方程）

**目标：**  
明确误差状态的组成，以及误差状态如何随时间演化（F、G 矩阵含义）。

**误差状态向量建议：**

- 姿态误差（3）
- 速度误差（3）
- 位置误差（3）
- 陀螺零偏误差（3）
- 加计零偏误差（3）

**需要梳理的内容：**

- 每个误差分量的物理含义：
  - 姿态误差如何由陀螺噪声和零偏引起
  - 速度误差、位置误差如何与姿态误差、加计误差耦合
  - 零偏如何作为随机游走过程存在
- 连续时间误差方程 → 离散化：
  - 根据名义状态和 IMU 测量，构造状态转移矩阵 F
  - 构造噪声传递矩阵 G，与过程噪声一起构成 Q

**作用：**

- 在 ESKF 预测步骤中更新：
  - 误差状态估计
  - 协方差矩阵 P

---

## 第 5 步：松耦合 ESKF 实现（INS + GNSS 导航解）

**目标：**  
使用 GNSS 导航解修正 INS 漂移，作为紧耦合的对照基准。

**量测设计：**

- 量测 z：
  - GNSS 提供的位置、速度（以及可选姿态）
- 量测残差：
  - 残差 ≈ GNSS 导航量 − INS 名义导航量
- 量测矩阵 H：
  - 建立“量测残差”和“误差状态”的线性关系

**滤波流程（每个时间步）：**

1. **预测（Predict）：**
   - 根据 F、G 和 IMU 信息，推进误差状态和协方差

2. **更新（Update）：**
   - 若当前有 GNSS 导航解且不处于遮挡：
     - 构造量测残差
     - 使用 H、R 计算卡尔曼增益
     - 更新误差状态估计和协方差
     - 用误差状态修正名义姿态/速度/位置
     - 重置误差状态为零（ESKF 的标准操作）

**输出：**

- 一条“松耦合融合轨迹”，可与纯 INS 和紧耦合做误差对比。

---

## 第 6 步：紧耦合 ESKF 实现（INS + GNSS 原始观测）

**目标：**  
以 GNSS 原始观测（伪距/伪距率/多普勒）为量测，构建紧耦合 ESKF，实现更强鲁棒性。

**量测设计：**

- 量测 z：
  - 多颗卫星的伪距和伪距率/多普勒
- 量测预测：
  - 由名义位置 + 卫星位置 → 预测伪距
  - 由名义速度 + 卫星相对速度 → 预测伪距率/多普勒
- 量测残差：
  - 残差 = 实测伪距/伪距率 − 预测值
- 量测矩阵 H：
  - 将位置误差、速度误差等与伪距/伪距率残差联系起来（线性化）

**滤波流程与松耦合类似，只是量测不同：**

1. **预测：**
   - 使用同样的误差状态方程（F、G、Q）

2. **更新：**
   - 若当前有 GNSS 原始观测（且不在遮挡期）：
     - 使用伪距/伪距率构造残差
     - 基于线性化量测模型计算 H
     - 进行卡尔曼更新，修正误差状态与协方差
     - 修正名义状态，重置误差状态为零

**输出：**

- 紧耦合融合轨迹，是论文的主结果之一。

---

## 第 7 步：约束与遮挡控制（伪量测 + 场景控制）

**目标：**  
在滤波中加入几何约束和实验遮挡逻辑，验证系统在 GNSS 不可用时的性能。

### 7.1 约束处理（伪量测形式）

常见约束：

- 双天线基线长度约束
- 静止时的零速度/零角速度约束（ZUPT 思想）
- 其他几何或物理约束（如高度、航向约束）

处理方式：

- 将约束条件写成“期望值 = 实际估计值”的形式  
- 构造约束残差（类似于量测残差）  
- 设定较小的约束噪声，使用类似卡尔曼更新的方式对误差状态进行修正

### 7.2 GNSS 遮挡控制逻辑

- 根据配置文件指定的遮挡时间段，控制：
  - 在遮挡期间，不向松/紧耦合滤波器提供真实 GNSS 量测
  - 纯靠 INS 预测和约束更新
- 记录遮挡前、遮挡中、遮挡后各时间段的姿态误差变化

---

## 第 8 步：精度评估与可视化

**目标：**  
统一对不同方案进行误差计算和图表生成，服务于论文写作。

**误差指标：**

- 对每种方案（纯 INS / 松耦合 / 紧耦合）分别计算：
  - 滚转/俯仰/航向误差的：
    - 均值（偏置）
    - 均方根（RMS）
    - 最大误差
    - 标准差
- 针对不同时间段：
  - 全程
  - GNSS 正常区间
  - GNSS 遮挡区间（可细分遮挡 0–10 s，10–30 s 等）

**可视化内容：**

- 姿态随时间变化曲线（真值 + 不同融合方案）
- 姿态误差随时间变化曲线（标出遮挡区域）
- 误差直方图、箱线图（反映误差分布）

**输出形式：**

- 表格：用于论文中的精度指标总结
- 图片：用于论文中的曲线和误差分布图

---

## 第 9 步（可选）：神经网络辅助遮挡仿真

> 该部分为可选扩展，不是主线，可以在主功能完成后再考虑。

**目标：**  
在 GNSS 遮挡期间，用一个简单的神经网络预测“伪 GNSS 量测”，观察是否能减缓误差发散。

**基本思路：**

1. 在 GNSS 正常时段，从 IMU + GNSS 数据中构建训练样本：
   - 输入：过去一段时间的 IMU（及必要的历史 GNSS）
   - 输出：当前时刻的 GNSS 导航量（位置/速度/姿态）
2. 训练一个简单的回归网络（例如多层感知机或浅层 LSTM）
3. 在遮挡仿真实验中：
   - 遮挡期间不使用真实 GNSS
   - 使用网络输出作为“伪 GNSS 量测”输入紧耦合 ESKF
4. 在评估模块中，比较：
   - 紧耦合（无 NN）遮挡误差
   - 紧耦合 + NN 辅助遮挡误差

---

## 推荐实现顺序（建议）

1. 配置系统与目录结构搭建  
2. 数据读取与时间对齐  
3. 纯 INS 惯导解算（名义状态）  
4. 误差状态模型的数学梳理（ESKF）  
5. 松耦合 ESKF 实现与验证  
6. 紧耦合 ESKF 实现与验证（重点）  
7. 约束与遮挡控制逻辑，实现遮挡实验  
8. 精度评估模块与图表生成  
9. （有余力时）再做简单神经网络辅助遮挡仿真

---

通过以上步骤，你可以按模块逐步实现和调试整个 INS/双天线 GNSS 姿态测量系统，并在论文中系统地展示：  
- 纯惯导 vs 松耦合 vs 紧耦合  
- GNSS 遮挡前/中/后的姿态精度变化  
- （可选）神经网络辅助遮挡的效果对比。
